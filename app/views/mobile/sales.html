<div class="container-fluid">
   <!-- Top Stats -->
   <div class="row">
      <div class="col-xs-12">
         <div class="col-xs-6">
            <div class="panel panel-default panel-heading-tile">
               <div class="panel-body" id="divGrossSales">
                  <h2><b><div class="text-center" id="grossSales"></div></b></h2>
                  <div class="panel-footer text-center" id="divGrossSales">
                     <small class="pull-right"><span id="infoGrossSales" class="glyphicon glyphicon-question-sign"></span></small>
                     <b>Gross Sales</b><br>
                     <b><div class="ly" id="grossSalesLy">&nbsp</div></b>
                  </div>
               </div>
            </div>
         </div>
         <div class="col-xs-6">
            <div class="panel panel-default panel-tile panel-heading-tile">
               <div class="panel-body" id="divDiscounts">
                  <h2><b><div class="text-center" id="checkAverage"></div></b></h2>
                  <div class="panel-footer text-center" id="divCheckAverage">
                     <b>Check Avg</b><br>
                     <b><div class="ly" id="checkAverageLy">&nbsp</div></b>
                  </div>
               </div>
            </div>
         </div>
      </div>
   </div>
   <div class="row">
      <div class="col-xs-12">
         <div class="col-xs-6">
            <div class="panel panel-default panel-heading-tile">
               <div class="panel-body" id="divGrossSales">
                  <h2><b><div class="text-center" id="guestAverage"></div></b></h2>
                  <div class="panel-footer text-center" id="divGuestAverage">
                     <b>Guest Avg</b><br>
                     <b><div class="ly" id="guestAverageLy">&nbsp</div></b>
                  </div>
               </div>
            </div>
         </div>
         <div class="col-xs-6">
            <div class="panel panel-default panel-heading-tile">
               <div class="panel-body" id="divTotalEntrees">
                  <h2><b><div class="text-center" id="totalEntrees"></div></b></h2>
                  <div class="panel-footer text-center" id="divTotalEntrees">
                     <b>Entrees</b><br>
                     <b><div class="ly" id="totalEntreesLy">&nbsp</div></b>
                  </div>
               </div>
            </div>
         </div>
      </div>
      </div>

      <div class="row">
         <div class="col-xs-12">
            <div class="col-xs-6">
               <div class="panel panel-default panel-heading-tile">
                  <div class="panel-body" id="divGrossSales">
                     <h2><b><div class="text-center" id="totalGuests"></div></b></h2>
                     <div class="panel-footer text-center" id="divTotalGuests">
                        <b>Guests</b><br>
                        <b><div class="ly" id="totalGuestsLy">&nbsp</div></b>
                     </div>
                  </div>
               </div>
            </div>
            <div class="col-xs-6">
               <div class="panel panel-default panel-tile panel-heading-tile">
                  <div class="panel-body" id="divTotalChecks">
                     <h2><b><div class="text-center" id="totalChecks"></div></b></h2>
                     <div class="panel-footer text-center" id="divTotalChecks">
                        <b>Checks</b><br>
                        <b><div class="ly" id="totalChecksLy">&nbsp</div></b>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <!-- End Top Stats -->

      <div class="row">
         <div class="col-lg-6">
            <div class="panel panel-default">
               <div class="panel-heading">
                  <i class="fa fa-pie-chart-o fa-fw"></i><b>Payment Methods <small class="pull-right"><span id="infoPayment" class="glyphicon glyphicon-question-sign"></small></b>
               </div>
               <div class="panel-body" style="overflow-y: scroll">
                  <div class="col-lg-12">
                     <div id="paymentMethods"></div>
                  </div>
               </div>
            </div>
         </div>
         <div class="col-lg-6">
            <div class="panel panel-default">
               <div class="panel-heading">
                  <i class="fa fa-pie-chart-o fa-fw"></i><b>Profit Centers <small class="pull-right"><span id="infoProfitCenters" class="glyphicon glyphicon-question-sign"></small></b>
               </div>
               <div class="panel-body" style="overflow-y: scroll">
                  <div class="col-lg-12">
                     <div id="profitCenterDetails"></div>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <div class="row">
         <div class="col-lg-6">
            <div class="panel panel-default">
               <div class="panel-heading">
                  <i class="fa fa-pie-chart-o fa-fw"></i><b>Server Sales <small class="pull-right"><span id="infoServerSales" class="glyphicon glyphicon-question-sign"></small></b>
               </div>
               <div class="panel-body" style="overflow-y: scroll">
                  <div class="col-lg-12">
                     <div id="salesByServer"></div>
                  </div>
               </div>
            </div>
         </div>
         <div class="col-lg-6">
            <div class="panel panel-default">
               <div class="panel-heading">
                  <i class="fa fa-pie-chart-o fa-fw"></i><b>Hourly Sales <small class="pull-right"><span id="infoHourlySales" class="glyphicon glyphicon-question-sign"></small></b>
                  <b class="pull-right"><div class="btn-group bgTimeframe" role="group"><button type="button" class="btn btn-success btn-xs" id="btnHourly">Hour</button>&nbsp<button type="button" class="btn btn-default btn-xs" id="btnHalfHour">Half</button>&nbsp<button type="button" class="btn btn-default btn-xs" id="btnQtr">Quarter</button></div></b>
               </div>
               <div class="panel-body" style="overflow-y: scroll">
                  <div class="col-lg-12">
                     <div id="hourlySales"></div>
                  </div>
               </div>
            </div>
         </div>
      </div>
      <div class="row">
         <div class="col-lg-6">
            <div class="panel panel-default">
               <div class="panel-heading">
                  <i class="fa fa-pie-chart-o fa-fw"></i><b>Mealtime Sales <small class="pull-right"><span id="infoMealtimeSales" class="glyphicon glyphicon-question-sign"></small></b>
               </div>
               <div class="panel-body" style="overflow-y: scroll">
                  <div class="col-lg-12">
                     <div id="mealtimeSales"></div>
                  </div>
               </div>
            </div>
         </div>
         <div class="col-lg-6">
            <div class="panel panel-default">
               <div class="panel-heading">
                  <i class="fa fa-pie-chart-o fa-fw"></i><b>Sales By Room<small class="pull-right"><span id="infoSalesByRoom" class="glyphicon glyphicon-question-sign"></small></b>
               </div>
               <div class="panel-body" style="overflow-y: scroll">
                  <div class="col-lg-12">
                     <div id="roomSales"></div>
                  </div>
               </div>
            </div>
         </div>
         <!--
         <div class="col-lg-6">
           <div class="panel panel-default">
              <div class="panel-heading">
                 <i class="fa fa-pie-chart-o fa-fw"></i><b>Table Turns by Room <small class="pull-right"><span id="infoTableTurns" class="glyphicon glyphicon-question-sign"></small></b>
              </div>
              <div class="panel-body" style="overflow-y: scroll">
                 <div class="col-lg-12">
                    <div id="tableTurns"></div>
                 </div>
              </div>
           </div>
         </div>
         -->
      </div>
   <!--
      <div class="row">
         <div class="col-lg-6">
            <div class="panel panel-default">
               <div class="panel-heading">
                  <i class="fa fa-pie-chart-o fa-fw"></i><b>Item Sales<small class="pull-right"><span id="infoItemSales" class="glyphicon glyphicon-question-sign"></small></b>
               </div>
               <div class="panel-body" style="overflow-y: scroll">
                  <div class="col-lg-12">
                     <table id="tblItems" class="table table-condensed table-striped table-bordered">
                        <thead>
                           <tr>
                              <th class="text-center"><b>Item Name</b></th>
                              <th class="centered"><b>Sales</b></th>
                              <th class="centered"></th>
                           </tr>
                           <tr>
                              <th>
                                 <h6><b>Selections will be saved when searching</b></h6>
                              </th>
                              <th>
                              </th>
                           </tr>
                        </thead>
                        <tbody id="tbItems">

                        </tbody>
                     </table>
                  </div>
               </div>
               <div class="panel-footer">
                  <div class="input-group" id="igItem">
                     <span class="input-group-addon"><i class="glyphicon glyphicon-user"></i></span>
                     <input id="tbItemName" type="text" class="form-control" name="store" placeholder="Enter item name">
                  </div>
               </div>
            </div>
         </div>
      </div>
      -->
   </div>

<script src="js/stupidtable.js"></script>

<script>
   var isMobile = 1;
   refreshData();

   window.setInterval(function ()
   {
      if (localStorage.getItem("needUpdate") == 1)
      {
         var user = localStorage.getItem("user");
         var pass = localStorage.getItem("pass");
         var selectedStore = localStorage.getItem("selectedStore");
         var selectedDate = localStorage.getItem("selectedDate");
         var token = localStorage.getItem("token");
         var cg = localStorage.getItem("cg");
         var license = localStorage.getItem("license");
         refreshData();
         localStorage.setItem("needUpdate", 0);
      }
   }, 500);

   function refreshData()
   {
      // var url = 'http://192.168.0.66:34295/';
      var url = 'http://rpower.com:1337/';

      var user = localStorage.getItem("user");
      var pass = localStorage.getItem("pass");
      var selectedStore = localStorage.getItem("selectedStore");
      var selectedDate = localStorage.getItem("selectedDate");
      var token = localStorage.getItem("token");
      var cg = localStorage.getItem("cg");
      var license = localStorage.getItem("license");

      hourlySales('hourly');

      var postData = { dateSelected: selectedDate, selectedStore: selectedStore, cg: cg, user: user, pass: pass, license: license, token: token, isMobile: 1 };

      $.ajax({
         url: url + 'salesOverview',
         dataType: 'json',
         crossDomain: true,
         method: 'post',
         data: postData,
         success: function (data)
         {
            $('#grossSales').html(data.gross);
            $('#checkAverage').html(data.checkavg);
            $('#guestAverage').html(data.guestavg);
            $('#totalChecks').html(data.checks);
            $('#totalGuests').html(data.guests);
            $('#totalEntrees').html(data.entrees);

            if (data[999999999])
            {
               var totalPIOLy = +data[999999999].paidIO;

               if (isNaN(totalPIOLy))
               {
                  totalPIOLy = 0;
               }

               $('#totalGuestsLy').html("LY: " + data[999999999].guest_count);
               $('#totalChecksLy').html("LY: " + data[999999999].total_checks);
               $('#totalEntreesLy').html("LY: " + data[999999999].entree_count);
               $('#grossSalesLy').html("LY: " + data[999999999].grossSalesLy);
               $('#totalBeveragesLy').html("LY: " + data[999999999].totalBeveragesLy);
               $('#guestAverageLy').html("LY: " + data[999999999].guestavgLY);
               $('#checkAverageLy').html("LY: " + data[999999999].checkavgLY);
            }
            else
            {
               $('#totalGuestsLy').html("LY: No Data");
               $('#totalChecksLy').html("LY: No Data");
               $('#totalEntreesLy').html("LY: No Data");
               $('#grossSalesLy').html("LY: No Data");
               $('#totalBeveragesLy').html("LY: No Data");
               $('#guestAverageLy').html("LY: No Data");
               $('#checkAverageLy').html("LY: No Data");
            }
         },
         error: function (data)
         {
            $('#grossSales').html("No Data");
            $('#checkAverage').html("No Data");
            $('#guestAverage').html("No Data");
            $('#totalChecks').html("No Data");
            $('#totalGuests').html("No Data");
            $('#totalEntrees').html("No Data");
            $('#totalGuestsLy').html("LY: No Data");
            $('#totalChecksLy').html("LY: No Data");
            $('#totalEntreesLy').html("LY: No Data");
            $('#grossSalesLy').html("LY: No Data");
            $('#totalBeveragesLy').html("LY: No Data");
            $('#guestAverageLy').html("LY: No Data");
            $('#checkAverageLy').html("LY: No Data");
            errorHandler(data);
         },
      });

      $.ajax({
         url: url + 'paymentMethodHTML',
         dataType: 'html',
         crossDomain: true,
         method: 'post',
         data: postData,
         success: function (data)
         {
            $('#paymentMethods').html(data);
            $("#tblPmt").stupidtable();
         },
         error: function (data)
         {
            errorHandler(data);
         },
      });

      $.ajax({
         url: url + 'profitCenterDetailsHTML',
         dataType: 'html',
         crossDomain: true,
         method: 'post',
         data: postData,
         success: function (data)
         {
            $('#profitCenterDetails').html(data);
            $("#tblPC").stupidtable();
         },
         error: function (data)
         {
            errorHandler(data);
         },
      });

      $.ajax({
         url: url + 'salesByServerHTML',
         dataType: 'html',
         crossDomain: true,
         method: 'post',
         data: postData,
         success: function (data)
         {
            $('#salesByServer').html(data);
            $("#tblSBS").stupidtable();
         },
         error: function (data)
         {
            errorHandler(data);
         },
      });

      $.ajax({
         url: url + 'mealtimeSalesHTML',
         dataType: 'html',
         crossDomain: true,
         method: 'post',
         data: postData,
         success: function (data)
         {
            $('#mealtimeSales').html(data);
            $("#tblMTS").stupidtable();
         },
         error: function (data)
         {
            errorHandler(data);
         },
      });

      $.ajax({
         url: url + 'roomSalesHTML',
         dataType: 'html',
         crossDomain: true,
         method: 'post',
         data: postData,
         success: function (data)
         {
            $('#roomSales').html(data);
            $("#tblRoomSales").stupidtable();
         },
         error: function (data)
         {
            errorHandler(data);
         },
      });
   }

   function hourlySales(timeFrame)
   {
      // var url = 'http://192.168.0.66:34295/';
      var url = 'http://rpower.com:1337/';

      var user = localStorage.getItem("user");
      var pass = localStorage.getItem("pass");
      var selectedStore = localStorage.getItem("selectedStore");
      var selectedDate = localStorage.getItem("selectedDate");
      var token = localStorage.getItem("token");
      var cg = localStorage.getItem("cg");
      var license = localStorage.getItem("license");

      var postData = { dateSelected: selectedDate, selectedStore: selectedStore, cg: cg, user: user, pass: pass, license: license, token: token, isMobile: isMobile, timeFrame: timeFrame };

      $.ajax({
         url: url + 'hourlySalesHTML',
         dataType: 'html',
         crossDomain: true,
         method: 'post',
         data: postData,
         success: function (data)
         {
            $('#hourlySales').html(data);
            $("#tblHourlySales").stupidtable();
         },
         error: function (data)
         {
            errorHandler(data);
         },
      });
   }

   $('#btnHourly').click(function (e)
   {
      $(".bgTimeframe > .btn").addClass("btn-default");
      $(".bgTimeframe > .btn").removeClass("btn-success");
      $("#btnHourly").addClass("btn-success");
      hourlySales('hourly');
   });

   $('#btnHalfHour').click(function (e)
   {
      $(".bgTimeframe > .btn").addClass("btn-default");
      $(".bgTimeframe > .btn").removeClass("btn-success");
      $("#btnHalfHour").addClass("btn-success");
      hourlySales('halfhour');
   });

   $('#btnQtr').click(function (e)
   {
      $(".bgTimeframe > .btn").addClass("btn-default");
      $(".bgTimeframe > .btn").removeClass("btn-success");
      $("#btnQtr").addClass("btn-success");
      hourlySales('quarter');
   });


   $('#btnHourly').click(function(e)
   {
      $(".bgTimeframe > .btn").addClass("btn-default");
      $(".bgTimeframe > .btn").removeClass("btn-success");
      $("#btnHourly").addClass("btn-success");
      hourlySales(postData, 'hourly');
   });

   $('#btnHalfHour').click(function(e)
   {
      $(".bgTimeframe > .btn").addClass("btn-default");
      $(".bgTimeframe > .btn").removeClass("btn-success");
      $("#btnHalfHour").addClass("btn-success");
      hourlySales(postData, 'halfhour');
   });

   $('#btnQtr').click(function(e)
   {
      $(".bgTimeframe > .btn").addClass("btn-default");
      $(".bgTimeframe > .btn").removeClass("btn-success");
      $("#btnQtr").addClass("btn-success");
      hourlySales(postData, 'quarter');
   });

   $(document).on('click', '#tblPmt tr', function (e)
   {
      var rid = this.id.substring(3);
      var date = localStorage.getItem("selectedDate");
      k3PaymentCheckList(date, rid);
   });

   $('#infoPayment').click(function (e)
   {
      $('#mGHeader').html('<h3>Payments Grid</h3>');
      $('#mGBody').html('This is a net payment amount that includes Hash (I.E. Deposits and Gift Card Sales) <br /> * Indicates hash');
      $('#modalGeneric').modal("show");
   });

   $('#infoServerSales').click(function (e)
   {
      $('#mGHeader').html('<h3>Server Sales Grid</h3>');
      $('#mGBody').html('Matches with Server Sales on the Close Day Report. Does not include \'House Grat\' or other grats that are retained by the house and not paid to a staff member. Does not include Hash (I.E. Deposits and Gift Card Sales)');
      $('#modalGeneric').modal("show");
   });

   $('#infoProfitCenters').click(function (e)
   {
      $('#mGHeader').html('<h3>Profit Center Grid</h3>');
      $('#mGBody').html('Matches with the Profit Centers in \'Sales Totals\' on the Close Day Report. Includes Hash (I.E. Deposits and Gift Card Sales)');
      $('#modalGeneric').modal("show");
   });

   $('#infoHourlySales').click(function (e)
   {
      $('#mGHeader').html('<h3>Hourly Sales Grid</h3>');
      $('#mGBody').html('Shows sales by the time the item was added to the check. Does not include Hash (I.E. Deposits and Gift Card Sales)');
      $('#modalGeneric').modal("show");
   });

   $('#infoMealtimeSales').click(function (e)
   {
      $('#mGHeader').html('<h3>Mealtime Sales Grid</h3>');
      $('#mGBody').html('Shows sales by Mealtime. Does not include Hash (I.E. Deposits and Gift Card Sales)');
      $('#modalGeneric').modal("show");
   });

   $('#infoGrossSales').click(function (e)
   {
      $('#mGHeader').html('<h3>Gross Sales</h3>');
      $('#mGBody').html('This is a gross amount that does not include open checks. Includes Hash items such as Deposits and Gift Card Sales. <br /><b>Calculation: Item Sales - Discounts + Tax + Tips/Grat + Hash - Paid-Outs = Gross</b>');
      $('#modalGeneric').modal("show");
   });

   $('#infoTableTurns').click(function (e)
   {
      $('#mGHeader').html('<h3>Table Turns</h3>');
      $('#mGBody').html('This shows the total guests, entrees, beverages, and average time checks have been open on a table. For more accurate data, servers should close checks out in a timely manner.</b>');
      $('#modalGeneric').modal("show");
   });

   $('#infoSalesByRoom').click(function (e)
   {
      $('#mGHeader').html('<h3>Sales By Room</h3>');
      $('#mGBody').html('This shows sales by room.');
      $('#modalGeneric').modal("show");
   });

   $('#tbItemName').keyup(function (e)
   {
      var len = this.selectionEnd;
      var html = "";

      if (!len)
      {
         len = 0;
      }

      if (len > 2)
      {
         // Copy existing rows that are checked....
         var prepend = [];
         var skip = [];
         var tbl = $('#tblItemSales');
/*
         var len = tbl[0].rows.length - 1;

         for (var i = 0; i <= len; i++)
         {

            if (typeof (tbl[0].rows[i].dataset.storecg) !== 'undefined' && tbl[0].rows[i].cells[3].children[0].checked)
            {
               // cloneNode does not preserve the state of a checkbox
               // so we need to add that attribute when we clone
               var checked = tbl[0].rows[i].cloneNode(true)
               checked.cells[2].childNodes[0].setAttribute('checked', 'true');
               prepend.push(checked);
            }
         }

         // Prepend the html return with the current selected rows
         var pLen = prepend.length - 1;

         if (pLen >= 0)
         {
            for (var p = 0; p <= pLen; p++)
            {
               html += prepend[p].outerHTML;
               skip.push(prepend[p].dataset.storename);
            }
         }
         */
         var text = $('#tbItemName').val();
         var cg = localStorage.getItem('cg');

         var ret = searchItem(text).done(function (data)
         {
            data = JSON.parse(data)

            console.log(data);

            for (var i = 0; i < data.length; i++)
            {
               // need to check for duplicate rows from above
               var exists = skip.indexOf(data[i].itemName);

               if (exists == -1)  // if we have a duplicate store name, skip
               {
                  html += "<tr>";
                  html += "<th class=\"text-left\">" + data[i].itemName + "</th>";
                  html += "<th class=\"text-left\">" + data[i].itemSales + "</th>";
                  html += "<th class=\"centered\"><input type=\"checkbox\" /></th>"
                  html += "</tr>";
               }
            }

            $('#tbStores').html(html);

         });
      }
      else
      {

      }

   });

</script>
